# Authors: Florian Lercher, Gerald WÃ¼rsching, Tobias Mascetta. Cyber-Physical Systems Group, TUM


# --------------- Gitlab Internal Variables ------------------------
# Predefined inernal variables from gitlab ci: see https://docs.gitlab.com/ee/ci/variables/predefined_variables.html
# CI_REGISTRY: Gitlab Container Registry with Docker container for project
# CI_JOB_TOKEN: Token, valid as long as the job is running
# CI_PROJECT_DIR: path where project is cloned to and gitlab job runs from





# -------------- Variables from Docker container ----------------------------
# CRDC_DIR: commonroad-drivability-checker dir


stages:
  - compile
  - build-test-python
  - static-test
  - build-wheels
  - deploy
  - publish

image: $CI_REGISTRY/cps/commonroad-reachable-set/deps:ci          # default image -> built docker 

variables:
  CRDC_DIR: /dc   # Commonroad-Drivability-Checker, installed via CI-Docker
  BUILD_JOBS: 4

before_script:
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.lrz.de/".insteadOf "git@gitlab.lrz.de:"

.conda-init: &conda-init
  - conda init bash
  - source ~/.bashrc

.python-prepare: &python-prepare
  - python -m pip install --upgrade pip
  - pip install -r ./requirements.txt

### build C++ library ###
build-standalone:
  stage: compile
  script:
    - *conda-init
    - conda activate "cr$PYTHON_VER"
    - *python-prepare
    - mkdir build-debug && cd build-debug
    - cmake -DCRDC_DIR="$CRDC_DIR" -DPYTHON_VER="$PYTHON_VER" -DCMAKE_BUILD_TYPE=Debug ..
    - cmake --build . -- -j $BUILD_JOBS
  parallel:
    matrix:
      - PYTHON_VER: [37, 38, 39, 310]
  artifacts:
    paths:
      - pycrreach.*.so
    expire_in: 30 minutes


### build test python ###
build-test-python:
  stage: build-test-python
  before_script:
    - *conda-init
    - conda activate "cr$PYTHON_VER"
    - *python-prepare
  script:
    - cp pycrreach.*.so commonroad_reach
    - cd commonroad_reach/tests
    - pytest .
  parallel:
    matrix:
      - PYTHON_VER: [37, 38, 39, 310]
  artifacts:
    paths:
      - ./doc/build
    expire_in: 30 minutes


### static test ###
clang-tidy:
  stage: static-test
  script:
    - mkdir build && cd build
    - cmake -DCRDC_DIR="$CRDC_DIR" -DPYTHON_VER="37" -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..
    - cd ..
    - bash ./ci/clang-tidy.sh
  needs: []


### build wheels ###
# Currently using development branch of cr-drivability checker
build-wheels-py:
  stage: build-wheels
  image: $CI_REGISTRY/cps/commonroad-reachable-set/manylinux_wheelbuild:latest
  only: 
    - develop
    - main
  when: manual
  script:
    # Prepare build -> building from branch: develop
    - git clone -b develop git@gitlab.lrz.de:cps/commonroad-reachable-set.git
    - cd commonroad-reachable-set
    # Copy cpp standalone into commonroad-reach dir
    - cp ../pycrreach.*.so .
    # Update git submodules
    - git submodule update --init
    # Create distribution
    - *conda-init
    - conda activate "cr$PYTHON_VER"
    - *python-prepare
    - python setup.py sdist         # source distribution: create .tar file
    - python setup.py bdist_wheel   # build distribution: create .whl file    -> contains platform specific .dll etc.
    # Audit python wheels --> also needed to link the generated .so from the cpp package!
    - cd dist
    - auditwheel show *.whl
    - auditwheel repair *.whl
  parallel:
    matrix:
      - PYTHON_VER: [37, 38, 39, 310]
  artifacts:
    paths:
      - $CI_PROJECT_DIR/commonroad-reachable-set/dist


### deploy wheels ###
.install-twine: &install-twine
  - *conda-init
  - conda activate "cr39"
  - python -m pip install --upgrade pip
  - pip install twine

push-to-internal-registry:
  # push built wheels to the internal GitLab PyPi registry
  stage: deploy
  image: $CI_REGISTRY/cps/commonroad-reachable-set/manylinux_wheelbuild:latest
  when: manual
  only:
  # Only use branch develop to build
    - develop
  script:
    # use python module twine and gitlab internal variables
    - *install-twine
    - cd commonroad-reachable-set
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --skip-existing --repository-url https://gitlab.lrz.de/api/v4/projects/${CI_PROJECT_ID}/packages/pypi dist/wheelhouse/* dist/commonroad-reach-*.tar.gz --verbose
  needs:
    - job: build-wheels-py
      artifacts: true


push-to-external-pypi-test-registry:
  # push built wheels to the external PyPi test registry
  # at: https://test.pypi.org/project/commonroad-reach/
  stage: deploy
  image: $CI_REGISTRY/cps/commonroad-reachable-set/manylinux_wheelbuild:latest
  when: manual
  only:
    - main
  script:
    - *install-twine
    - cd cd commonroad-reachable-set
    - TWINE_PASSWORD=${CR_PYPI_TEST_API_TOKEN} TWINE_USERNAME=__token__ python -m twine upload --repository-url https://test.pypi.org/legacy/ dist/wheelhouse/* dist/commonroad-reach-*.tar.gz --verbose
  needs:
    - job: build-wheels-py
      artifacts: true

push-to-external-pypi-registry:
  # push built wheels to the external PyPi registry
  # at: https://pypi.org/project/commonroad-reach/
  stage: deploy
  image: $CI_REGISTRY/cps/commonroad-reachable-set/manylinux_wheelbuild:latest
  when: manual
  only:
    - main
  script:
    - *install-twine
    - cd commonroad-reachable-set
    - TWINE_PASSWORD=${CR_PYPI_RELEASE_API_TOKEN} TWINE_USERNAME=__token__ python -m twine upload dist/wheelhouse/* dist/commonroad-reach-*.tar.gz --verbose
  needs:
    - job: build-wheels-py
      artifacts: true


### publish documentation ###
pages:
  # Push the latest documentation of the main branch to the GitLab Pages documentation
  # at https://cps.pages.gitlab.lrz.de/commonroad-reachable-set
  stage: publish
  before_script:
    - *conda-init
    - conda activate cr37
    - *python-prepare
  script:
    - cp pycrreach.*.so commonroad_reach
    - pip install -r ./docs/requirements_doc.txt
    - cd docs/Sphinx
    - make html
    - mv ./build/html ../../public
  artifacts:
    paths:
      - public
  environment:
    name: Gitlab Pages
    url: https://cps.pages.gitlab.lrz.de/commonroad-reachable-set
  only:
    - main
